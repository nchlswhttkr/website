# prettier-ignore
steps:
  - label: ':hugo: Test build'
    if: 'build.branch != "main"'
    agents:
      website: nicholas.cloud
    command: hugo

  - label: ':shipit: Build and deploy site changes'
    if: 'build.branch == "main"'
    key: deploy
    agents:
      website: nicholas.cloud
    command: .buildkite/build.sh

  - label: ':mag: Scan for newsletters'
    if: 'build.branch == "main" && build.source != "schedule"'
    depends_on: deploy
    agents:
      website: nicholas.cloud
    command: .buildkite/trigger-newsletter-if-new-issue.sh

  - block: Purge Cloudflare cache for nicholas.cloud?
    key: purge-cloudflare-cache
    depends_on: deploy
  - label: ":cloudflare: Purge Cloudflare cache"
    depends_on: purge-cloudflare-cache
    agents:
      website: nicholas.cloud
    command: .buildkite/purge-cloudflare-cache.sh
